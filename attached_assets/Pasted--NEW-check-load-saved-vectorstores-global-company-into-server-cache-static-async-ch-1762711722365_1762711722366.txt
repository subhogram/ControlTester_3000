    // NEW: check & load saved vectorstores (global/company) into server cache.
    static async checkExistingVectorstores(preferredModel = null) {
        const result = {
            general: { exists: false, path: null, vector_count: 0, last_modified: null },
            company: { exists: false, path: null, vector_count: 0, last_modified: null }
        };

        try {
            let modelName = preferredModel;
            if (!modelName) {
                const models = await this.getModels();
                modelName = models?.[0] || "llama2";
            }

            const checks = [
                { type: "general", path: "saved_global_vectorstore", kb_type: "global" },
                { type: "company", path: "saved_company_vectorstore", kb_type: "company" }
            ];

            for (const check of checks) {
                try {
                    const form = new FormData();
                    form.append("dir_path", check.path);
                    form.append("kb_type", check.kb_type);
                    form.append("model_name", modelName);

                    const resp = await fetch(`${this.baseUrl}/load-vectorstore`, { method: "POST", body: form });

                    if (resp.ok) {
                        const data = await resp.json();
                        if (data?.success) {
                            result[check.type] = {
                                exists: true,
                                path: check.path,
                                vector_count: data.ntotal ?? data.vector_count ?? 0,
                                last_modified: new Date().toISOString()
                            };
                        } else {
                        }
                    } else {
                        await resp.text();
                    }
                } catch (e) {
                    // ignore
                }
            }

            return result;
        } catch (e) {
            // Return a conservative default (no mocks) to avoid confusing UI
            return result;
        }
    }

    static async buildKnowledgeBase(files, kbType, selectedModel, opts = {}) {
        if (!selectedModel) throw new Error("No model selected");
        if (!files?.length) throw new Error("No files to build KB");

        const form = new FormData();
        for (const f of files) form.append("files", f);
        form.append("selected_model", selectedModel);
        form.append("kb_type", kbType); // "global" | "company"
        form.append("batch_size", String(opts.batch_size ?? 15));
        form.append("delay_between_batches", String(opts.delay_between_batches ?? 0.2));
        form.append("max_retries", String(opts.max_retries ?? 3));

        const url = `${this.baseUrl}/build-knowledge-base`;
        const r = await fetch(url, { method: "POST", body: form });
        if (!r.ok) {
            const t = await r.text();
            throw new Error(`Build failed (${r.status}): ${t}`);
        }
        const data = await r.json();
        if (!data.success) throw new Error(data.error_details || data.message || "Build failed");

        return data;
    }
